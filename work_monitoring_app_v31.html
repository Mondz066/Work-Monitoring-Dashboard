<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Monitoring Dashboard</title>

    <!-- PWA Manifest Link - Placeholder -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme color for browser UI -->
    <meta name="theme-color" content="#111827">
    
    <!-- Apple-specific meta tags for PWA -->
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/34d399/ffffff?text=✔️">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Work Monitor">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles for aesthetics and animations */
        body { font-family: 'Inter', sans-serif; }
        .new-entry { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .summary-box { 
            display: flex; flex-direction: column; justify-content: center; min-height: 90px; text-align: center; 
            border: 1px solid rgba(156, 163, 175, 0.1); /* Light border */
        }
        .modal-backdrop { 
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px); /* Added a slight blur for better modal focus */
        }
        /* Custom scrollbar for better look in dark mode */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; /* gray-800 */ }
        ::-webkit-scrollbar-thumb { background: #4f46e5; /* indigo-600 */ border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6366f1; /* indigo-500 */ }
        /* Hide fields in fixed mode */
        .fixed-mode-hide { display: none; }
    </style>
</head>
<body class="bg-black text-gray-200">

    <div class="container mx-auto max-w-2xl p-4 sm:p-6">
        
        <header class="text-center my-6">
            <h1 class="text-4xl font-extrabold text-white tracking-tight">Work Monitoring Dashboard</h1>
            <!-- UPDATED SUBTITLE -->
            <p class="text-sm text-indigo-400 mt-2">by HenJr</p> 
        </header>

        <!-- MANUAL ENTRY FORM SECTION -->
        <div class="bg-gray-900 rounded-2xl shadow-2xl p-6 mb-8 border border-indigo-700/50">
            <h2 class="text-xl font-bold mb-4 text-white flex items-center gap-2">
                <svg class="w-6 h-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                Add Log Entry
            </h2>
            <form id="log-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                        <input type="date" id="date" name="date" required class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white transition duration-150">
                    </div>
                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-300 mb-1">Status</label>
                        <!-- START STATUS DROPDOWN UPDATE -->
                        <select id="status" name="status" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white transition duration-150">
                            <option value="Present">Present (Regular Work Day)</option>
                            <option value="Legal Holiday (200%)">Legal Holiday (200% Rate)</option>
                            <option value="Special Holiday (130%)">Special Holiday (130% Rate)</option>
                            <option value="Non-Work Day">Leave/No work (Non Paid)</option>
                            <option value="Rest Day">Rest Day</option>
                            <option value="Legal/Special Holiday Non-Work">Legal/Special Holiday (NonWork)</option>
                        </select>
                        <!-- END STATUS DROPDOWN UPDATE -->
                    </div>
                </div>

                <!-- SHIFT PRESETS (Updated to include OT shifts) -->
                <div id="shift-presets" class="mt-4 flex flex-wrap gap-2">
                    <!-- Standard Shifts -->
                    <button type="button" data-start="06:00" data-end="14:00" class="flex-1 min-w-[30%] sm:min-w-0 bg-green-700/50 text-green-300 font-medium py-2 rounded-xl text-sm hover:bg-green-700 transition duration-150 transform hover:scale-[1.02] active:scale-[0.98]">Day (06:00-14:00)</button>
                    <button type="button" data-start="14:00" data-end="22:00" class="flex-1 min-w-[30%] sm:min-w-0 bg-orange-700/50 text-orange-300 font-medium py-2 rounded-xl text-sm hover:bg-orange-700 transition duration-150 transform hover:scale-[1.02] active:scale-[0.98]">Mid (14:00-22:00)</button>
                    <button type="button" data-start="22:00" data-end="06:00" class="flex-1 min-w-[30%] sm:min-w-0 bg-blue-700/50 text-blue-300 font-medium py-2 rounded-xl text-sm hover:bg-blue-700 transition duration-150 transform hover:scale-[1.02] active:scale-[0.98]">Night (22:00-06:00)</button>
                    
                    <!-- New OT Shifts -->
                    <button type="button" data-start="06:00" data-end="18:00" class="flex-1 min-w-[45%] sm:min-w-0 bg-red-700/50 text-red-300 font-medium py-2 rounded-xl text-sm hover:bg-red-700 transition duration-150 transform hover:scale-[1.02] active:scale-[0.98]">Day OT (06:00-18:00)</button>
                    <button type="button" data-start="18:00" data-end="06:00" class="flex-1 min-w-[45%] sm:min-w-0 bg-pink-700/50 text-pink-300 font-medium py-2 rounded-xl text-sm hover:bg-pink-700 transition duration-150 transform hover:scale-[1.02] active:scale-[0.98]">Night OT (18:00-06:00)</button>
                </div>

                <div id="present-details" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="start-time" class="block text-sm font-medium text-gray-300 mb-1">Clock In Time</label>
                        <input type="time" id="start-time" name="start-time" value="06:00" required class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white transition duration-150">
                    </div>
                    <div>
                        <label for="end-time" class="block text-sm font-medium text-gray-300 mb-1">Clock Out Time</label>
                        <input type="time" id="end-time" name="end-time" value="14:00" required class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white transition duration-150">
                    </div>
                </div>

                <div class="mt-4">
                    <label for="notes" class="block text-sm font-medium text-gray-300 mb-1">Notes (Optional)</label>
                    <textarea id="notes" name="notes" rows="2" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white transition duration-150" placeholder="e.g., Worked on project X or reason for leave/holiday..."></textarea>
                </div>

                <div class="mt-6">
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-xl shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-gray-900 transition-all duration-300 transform hover:scale-[1.01] active:scale-[0.99]">
                        <span class="flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2m-9 0a2 2 0 002 2h4a2 2 0 002-2m-4 6h4m-4 4h4"></path></svg>
                            Add Log Entry
                        </span>
                    </button>
                </div>
            </form>
        </div>
        
        <!-- SETTINGS SECTION -->
        <div class="bg-gray-900 rounded-2xl shadow-2xl p-6 mb-8 border border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-white flex items-center gap-2">
                <svg class="w-6 h-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.942 3.313.823 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.942 1.543-.823 3.313-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.942-3.313-.823-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.942-1.543.823-3.313 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                Settings & Data Management
            </h2>
            <div class="grid grid-cols-2 gap-3">
                 <button id="pay-rate-btn" class="bg-purple-600 text-white font-medium py-3 px-4 rounded-xl shadow-md hover:bg-purple-700 transition duration-150 transform hover:scale-[1.02] active:scale-[0.98]">Pay Rate Settings</button>
                 <button id="manage-data-btn" class="bg-gray-600 text-white font-medium py-3 px-4 rounded-xl shadow-md hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02] active:scale-[0.98]">Manage Log Data</button>
            </div>
        </div>
        <!-- END SETTINGS SECTION -->


        <!-- SUMMARY SECTION -->
        <div class="bg-gray-900 rounded-2xl shadow-2xl p-6 mb-8 border border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-white flex items-center gap-2">
                 <svg class="w-6 h-6 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>
                Pay Breakdown (Selected Month)
            </h2>
             <!-- PAY BREAKDOWN METRICS (Updated) -->
             <!-- MODIFIED: Changed layout to a single grid with 6 columns (3 rows of 2) -->
             <div class="grid grid-cols-2 sm:grid-cols-2 gap-3 mb-4">
                 <!-- SEPARATED REGULAR PAY (1/6) -->
                 <div id="summary-regular-box" class="summary-box bg-gray-800 p-3 rounded-xl">
                     <p id="summary-regular-label" class="text-xs font-semibold text-green-400">Total Regular Pay</p>
                     <p id="summary-regular-pay" class="text-xl font-bold text-green-300 mt-1">₱0.00</p>
                 </div>
                 <!-- SEPARATED OVERTIME PAY (2/6) -->
                 <div id="summary-overtime-box" class="summary-box bg-gray-800 p-3 rounded-xl">
                     <p id="summary-overtime-label" class="text-xs font-semibold text-pink-400">Total Overtime Pay</p>
                     <p id="summary-overtime-pay" class="text-xl font-bold text-pink-300 mt-1">₱0.00</p>
                 </div>
                 
                 <!-- SPECIAL HOLIDAY PAY (3/6) -->
                 <div class="summary-box bg-gray-800 p-3 rounded-xl">
                     <p class="text-xs font-semibold text-yellow-400">Special Hol. (130%) Pay</p>
                     <p id="summary-special-hol-pay" class="text-xl font-bold text-yellow-300 mt-1">₱0.00</p>
                 </div>
                 <!-- LEGAL HOLIDAY PAY (4/6) -->
                 <div class="summary-box bg-gray-800 p-3 rounded-xl">
                     <p class="text-xs font-semibold text-red-400">Legal Hol. (200%) Pay</p>
                     <p id="summary-legal-hol-pay" class="text-xl font-bold text-red-300 mt-1">₱0.00</p>
                 </div>
                 
                 <!-- NON-WORKED PAID HOLIDAY PAY (5/6) -->
                 <div class="summary-box bg-gray-800 p-3 rounded-xl">
                     <p class="text-xs font-semibold text-indigo-400">Non-Worked Paid Hol. Pay</p>
                     <p id="summary-non-worked-paid-hol-pay" class="text-xl font-bold text-indigo-300 mt-1">₱0.00</p>
                 </div>
                 
                 <!-- TOTAL NIGHT DIFFERENTIAL PAY (6/6) - Now aligned with Non-Worked Paid Hol. -->
                 <div class="summary-box bg-gray-800 p-3 rounded-xl border border-blue-700/50">
                     <p class="text-xs font-semibold text-blue-400">Total Night Differential Pay</p>
                     <!-- Changed text-2xl to text-xl for alignment consistency with siblings -->
                     <p id="summary-night-differential-pay" class="text-xl font-bold text-blue-300 mt-1">₱0.00</p>
                 </div>
             </div>
             <!-- END MODIFIED PAY BREAKDOWN METRICS -->

            <!-- Total Pay Box -->
             <div class="grid grid-cols-1">
                <div class="summary-box bg-indigo-900/50 p-3 rounded-xl border border-indigo-700/50">
                    <p class="text-xs font-semibold text-indigo-300">Total Estimated Gross Pay (Selected Month)</p>
                    <p id="summary-total-pay" class="text-3xl font-extrabold text-indigo-200 mt-1">₱0.00</p>
                </div>
            </div>

            <!-- SHIFT HOURS SUMMARY (UPDATED FOR ALIGNMENT) -->
            <h3 class="text-lg font-bold mb-3 mt-6 text-gray-300 border-t border-gray-700 pt-4">Hours Summary (Selected Month)</h3>
            
            <div id="overall-hours-summary-container" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-3">
                
                <!-- 1. Total Shift Hours (Aligned) -->
                <div class="summary-box bg-gray-800 p-3 rounded-xl border border-green-700/50">
                    <p class="text-xs font-semibold text-green-400">Total Shift Hours</p>
                    <p id="summary-regular-hours-total" class="text-xl font-bold text-green-300 mt-1">0h 00m</p>
                </div>

                <!-- 2. Total Overtime Hours (Aligned) -->
                <div class="summary-box bg-gray-800 p-3 rounded-xl">
                    <p class="text-xs font-semibold text-pink-400">Total Overtime Hours</p>
                    <p id="summary-total-overtime-hours" class="text-xl font-bold text-pink-300 mt-1">0h 00m</p>
                </div>

                <!-- 3. NEW: Night Diff Hours -->
                <div class="summary-box bg-gray-800 p-3 rounded-xl border border-blue-700/50">
                    <p class="text-xs font-semibold text-blue-400">Night Diff Hours</p>
                    <p id="summary-night-diff-hours" class="text-xl font-bold text-blue-300 mt-1">0h 00m</p>
                </div>
                
                <!-- 4. Special Hol. Hours -->
                <div class="summary-box bg-gray-800 p-3 rounded-xl"><p class="text-xs font-semibold text-yellow-400">Special Hol. Hours</p><p id="summary-special-hol-hours-total" class="text-xl font-bold text-yellow-300 mt-1">0h 00m</p></div>
                
                <!-- 5. Legal Hol. Hours -->
                <div class="summary-box bg-gray-800 p-3 rounded-xl"><p class="text-xs font-semibold text-red-400">Legal Hol. Hours</p><p id="summary-legal-hol-hours-total" class="text-xl font-bold text-red-300 mt-1">0h 00m</p></div>
            </div>
            
            <div class="grid grid-cols-1 mt-3">
                 <div class="summary-box bg-gray-800 p-3 rounded-xl border-t border-cyan-700">
                     <p class="text-xs font-semibold text-cyan-400">Grand Total Worked Hours</p>
                     <p id="summary-total-worked-hours" class="text-2xl font-bold text-cyan-300 mt-1">0h 00m</p>
                 </div>
            </div>
            <!-- END SHIFT HOURS SUMMARY -->

            <h3 class="text-lg font-bold mb-3 mt-6 border-t border-gray-700 pt-4 text-gray-300">Days Count (Selected Month)</h3>
            <div id="summary-days-container" class="grid grid-cols-2 sm:grid-cols-4 gap-3"></div>
        </div>
        <!-- END SUMMARY SECTION -->
        
        <!-- FILTER SECTION -->
        <div class="bg-gray-900 rounded-2xl shadow-2xl p-6 mb-6 border border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-white flex items-center gap-2">
                <svg class="w-6 h-6 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707v7l-4 4v-7a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                View History Filter & Export
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label for="month-filter" class="block text-sm font-medium text-gray-300 mb-1">Month</label>
                        <select id="month-filter" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg text-white transition duration-150">
                            <option value="0">January</option><option value="1">February</option><option value="2">March</option>
                            <option value="3">April</option><option value="4">May</option><option value="5">June</option>
                            <option value="6">July</option><option value="7">August</option><option value="8">September</option>
                            <option value="9">October</option><option value="10">November</option><option value="11">December</option>
                        </select>
                    </div>
                    <div>
                        <label for="year-filter" class="block text-sm font-medium text-gray-300 mb-1">Year</label>
                        <select id="year-filter" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg text-white transition duration-150"></select>
                    </div>
                </div>
                <div class="flex flex-col gap-2 self-end">
                    <button id="apply-filter-btn" class="w-full bg-blue-600 text-white font-medium py-3 px-4 rounded-xl shadow-md hover:bg-blue-700 transition duration-150 transform hover:scale-[1.01] active:scale-[0.99]">View Selected Month</button>
                    <!-- EXPORT BUTTON -->
                    <button id="export-csv-btn" class="w-full bg-green-600 text-white font-medium py-3 px-4 rounded-xl shadow-md hover:bg-green-700 transition duration-150 transform hover:scale-[1.01] active:scale-[0.99]">
                        <span class="flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Export to CSV
                        </span>
                    </button>
                </div>
            </div>
        </div>
        <!-- END FILTER SECTION -->

        <!-- LOG HISTORY LIST -->
        <div>
            <div class="flex justify-between items-center mb-4">
                 <h2 id="log-history-title" class="text-2xl font-bold text-white">Recent Log History</h2>
            </div>
            <div id="log-container" class="space-y-3">
                <p id="empty-log-message" class="text-gray-400 text-center py-8 bg-gray-900 rounded-xl border border-gray-700 shadow-inner">No entries yet. Add one above to get started!</p>
            </div>
        </div>
        <!-- END LOG HISTORY LIST -->
        
        <!-- DEDUCTIONS & NET PAY DASHBOARD -->
        <div class="bg-gray-900 rounded-2xl shadow-2xl p-6 mt-8 border border-red-700/50">
            <h2 class="text-xl font-bold mb-4 text-white flex items-center gap-2">
                <svg class="w-6 h-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                Monthly Deductions & Net Pay
            </h2>
            
            <div id="deductions-inputs" class="grid grid-cols-2 gap-4 border-b border-gray-700 pb-4 mb-4">
                
                <!-- Philhealth -->
                <div>
                    <label for="deduction-philhealth" class="block text-sm font-medium text-gray-300 mb-1">Philhealth (₱)</label>
                    <input type="number" step="0.01" min="0" id="deduction-philhealth" placeholder="0.00" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg shadow-sm text-white focus:ring-red-500 focus:border-red-500 deduction-input">
                </div>
                
                <!-- HDMF -->
                <div>
                    <label for="deduction-hdmf" class="block text-sm font-medium text-gray-300 mb-1">HDMF / Pag-IBIG (₱)</label>
                    <input type="number" step="0.01" min="0" id="deduction-hdmf" placeholder="0.00" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg shadow-sm text-white focus:ring-red-500 focus:border-red-500 deduction-input">
                </div>

                <!-- TAX -->
                <div>
                    <label for="deduction-tax" class="block text-sm font-medium text-gray-300 mb-1">TAX (₱)</label>
                    <input type="number" step="0.01" min="0" id="deduction-tax" placeholder="0.00" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg shadow-sm text-white focus:ring-red-500 focus:border-red-500 deduction-input">
                </div>
                
                <!-- Health Card -->
                <div>
                    <label for="deduction-healthcard" class="block text-sm font-medium text-gray-300 mb-1">Health Card (₱)</label>
                    <input type="number" step="0.01" min="0" id="deduction-healthcard" placeholder="0.00" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg shadow-sm text-white focus:ring-red-500 focus:border-red-500 deduction-input">
                </div>
                
                 <!-- SSS Loan -->
                <div>
                    <label for="deduction-sss-loan" class="block text-sm font-medium text-gray-300 mb-1">SSS Loan (₱)</label>
                    <input type="number" step="0.01" min="0" id="deduction-sss-loan" placeholder="0.00" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg shadow-sm text-white focus:ring-red-500 focus:border-red-500 deduction-input">
                </div>
                
                <!-- HDMF Loan -->
                <div>
                    <label for="deduction-hdmf-loan" class="block text-sm font-medium text-gray-300 mb-1">HDMF Loan (₱)</label>
                    <input type="number" step="0.01" min="0" id="deduction-hdmf-loan" placeholder="0.00" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg shadow-sm text-white focus:ring-red-500 focus:border-red-500 deduction-input">
                </div>
                
                <!-- SSS Calamity Loan -->
                <div>
                    <label for="deduction-sss-calamity-loan" class="block text-sm font-medium text-gray-300 mb-1">SSS Calamity Loan (₱)</label>
                    <input type="number" step="0.01" min="0" id="deduction-sss-calamity-loan" placeholder="0.00" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg shadow-sm text-white focus:ring-red-500 focus:border-red-500 deduction-input">
                </div>
            </div>

            <!-- Deduction Summary -->
            <div class="grid grid-cols-2 gap-3 mt-4">
                <div class="summary-box bg-gray-800 p-3 rounded-xl border border-red-500/50">
                    <p class="text-xs font-semibold text-red-400">Total Monthly Deduction</p>
                    <p id="summary-total-deduction" class="text-xl font-bold text-red-300 mt-1">₱0.00</p>
                </div>
                <div class="summary-box bg-green-900/50 p-3 rounded-xl border border-green-700/50">
                    <p class="text-xs font-semibold text-green-300">Estimated Net Pay</p>
                    <p id="summary-net-pay" class="text-2xl font-extrabold text-green-200 mt-1">₱0.00</p>
                </div>
            </div>
        </div>
        <!-- END DEDUCTIONS & NET PAY DASHBOARD -->
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal-backdrop" class="fixed inset-0 hidden items-center justify-center z-50 modal-backdrop">
        <div id="confirm-modal" class="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-6 w-11/12 max-w-lg mx-auto transform transition duration-300 scale-100">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4 text-white"></h3>
            <p id="confirm-modal-text" class="text-sm text-gray-400 mb-2"></p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="confirm-modal-cancel" class="bg-gray-600 text-gray-200 font-medium py-2 px-4 rounded-lg hover:bg-gray-500 transition duration-150">Cancel</button>
                <button type="button" id="confirm-modal-action" class="bg-red-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-red-700 transition duration-150"></button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal-backdrop" class="fixed inset-0 hidden items-center justify-center z-50 modal-backdrop">
        <div id="edit-modal" class="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-6 w-11/12 max-w-lg mx-auto transform transition duration-300 scale-100">
            <h3 class="text-xl font-bold mb-6 text-white">Edit Log Entry</h3>
            <form id="edit-form">
                <input type="hidden" id="edit-log-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                        <input type="date" id="edit-date" required class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white transition duration-150">
                    </div>
                    <div>
                        <label for="edit-status" class="block text-sm font-medium text-gray-300 mb-1">Status</label>
                         <!-- START EDIT STATUS DROPDOWN UPDATE -->
                        <select id="edit-status" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white transition duration-150">
                            <option value="Present">Present (Regular Work Day)</option>
                            <option value="Legal Holiday (200%)">Legal Holiday (200% Rate)</option>
                            <option value="Special Holiday (130%)">Special Holiday (130% Rate)</option>
                            <option value="Non-Work Day">Leave/No work (Non Paid)</option>
                            <option value="Rest Day">Rest Day</option>
                            <option value="Legal/Special Holiday Non-Work">Legal/Special Holiday (NonWork)</option>
                        </select>
                        <!-- END EDIT STATUS DROPDOWN UPDATE -->
                    </div>
                </div>
                 <div id="edit-present-details" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-start-time" class="block text-sm font-medium text-gray-300 mb-1">Clock In Time</label>
                        <input type="time" id="edit-start-time" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white transition duration-150">
                    </div>
                    <div>
                        <label for="edit-end-time" class="block text-sm font-medium text-gray-300 mb-1">Clock Out Time</label>
                        <input type="time" id="edit-end-time" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white transition duration-150">
                    </div>
                </div>
                <div class="mt-4">
                    <label for="edit-notes" class="block text-sm font-medium text-gray-300 mb-1">Notes</label>
                    <textarea id="edit-notes" rows="3" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white transition duration-150"></textarea>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="edit-modal-cancel" class="bg-gray-600 text-gray-200 font-medium py-2 px-4 rounded-lg hover:bg-gray-500 transition duration-150">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-150">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- PAY RATE SETTINGS MODAL -->
    <div id="rates-settings-modal-backdrop" class="fixed inset-0 hidden items-center justify-center z-50 modal-backdrop">
        <div id="rates-settings-modal" class="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-6 w-11/12 max-w-lg mx-auto transform transition duration-300 scale-100">
            <h3 class="text-xl font-bold mb-6 text-white flex items-center gap-2">
                <svg class="w-6 h-6 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V4m0 12v-4m-6 4h12a2 2 0 002-2V7a2 2 0 00-2-2H6a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                Pay Rate Settings
            </h3>
            <form id="rates-form" class="space-y-4">
                
                <!-- PAY MODE SELECTION -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Select Pay Structure</label>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="pay-mode" value="hourly" id="pay-mode-hourly" class="form-radio text-indigo-600 bg-gray-700 border-gray-600 focus:ring-indigo-500">
                            <span class="ml-2 text-white">Hourly Pay</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="pay-mode" value="fixed" id="pay-mode-fixed" class="form-radio text-indigo-600 bg-gray-700 border-gray-600 focus:ring-indigo-500">
                            <span class="ml-2 text-white">Fixed Monthly Pay</span>
                        </label>
                    </div>
                </div>
                
                <!-- FIXED PAY INPUT (Only visible in Fixed mode) -->
                 <div id="fixed-monthly-pay-group" class="hidden space-y-4">
                    <div>
                        <label for="rate-fixed-monthly" class="block text-sm font-medium text-gray-300 mb-1">Fixed Monthly Salary (₱)</label>
                        <input type="number" step="100" min="0" id="rate-fixed-monthly" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-purple-500 focus:border-purple-500 transition duration-150" placeholder="e.g., 20000.00">
                        <p class="text-xs text-gray-400 mt-1">Total base salary for the entire cycle.</p>
                    </div>
                    
                    <!-- UPDATED DESCRIPTION: Fixed Days per Cycle -->
                    <div>
                        <label for="rate-fixed-days-per-cycle" class="block text-sm font-medium text-gray-300 mb-1">Fixed Working Days per Cycle</label>
                        <input type="number" step="1" min="1" id="rate-fixed-days-per-cycle" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-purple-500 focus:border-purple-500 transition duration-150" placeholder="e.g., 26">
                        <p class="text-xs text-gray-400 mt-1">This determines the daily deduction rate: (Salary / Days) for non-paid leave days.</p>
                    </div>
                </div>

                <!-- HOURLY RATE GROUP (Used for ALL PREMIUMS in both modes) -->
                <div id="hourly-rate-group" class="space-y-4">
                    <div id="rate-regular-group" class="hourly-mode-only">
                        <label for="rate-regular" class="block text-sm font-medium text-gray-300 mb-1">Regular Hourly Rate (₱)</label>
                        <input type="number" step="0.01" min="0" id="rate-regular" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-purple-500 focus:border-purple-500 transition duration-150" placeholder="e.g., 25.00">
                        <p class="text-xs text-gray-400 mt-1">Used for calculating all hourly payments (required for premiums in Fixed mode).</p>
                    </div>
                    
                    <div>
                        <label for="rate-night-differential" class="block text-sm font-medium text-gray-300 mb-1">Night Differential Hourly Rate (₱)</label>
                        <input type="number" step="0.01" min="0" id="rate-night-differential" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g., 2.50">
                        <p class="text-xs text-gray-400 mt-1">Flat rate for 10 PM (22:00) to 6 AM (06:00) - **Always added as a premium.**</p>
                    </div>
                    
                    <div>
                        <label for="rate-overtime" class="block text-sm font-medium text-gray-300 mb-1">Overtime Hourly Rate (₱)</label>
                        <input type="number" step="0.01" min="0" id="rate-overtime" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-purple-500 focus:border-purple-500 transition duration-150" placeholder="e.g., 31.25">
                        <p class="text-xs text-gray-400 mt-1">Used for OT premiums.</p>
                    </div>
                    
                    <div>
                        <label for="rate-special-holiday" class="block text-sm font-medium text-gray-300 mb-1">Special Holiday Hourly Rate (₱)</label>
                        <input type="number" step="0.01" min="0" id="rate-special-holiday" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-purple-500 focus:border-purple-500 transition duration-150" placeholder="e.g., 32.50">
                        <p class="text-xs text-gray-400 mt-1">Used for Special Holiday premiums.</p>
                    </div>
                    
                    <div>
                        <label for="rate-legal-holiday" class="block text-sm font-medium text-gray-300 mb-1">Legal Holiday Hourly Rate (₱)</label>
                        <input type="number" step="0.01" min="0" id="rate-legal-holiday" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-purple-500 focus:border-purple-500 transition duration-150" placeholder="e.g., 50.00">
                        <p class="text-xs text-gray-400 mt-1">Used for Legal Holiday premiums.</p>
                    </div>
                </div>

                <div class="pt-4 flex justify-end">
                    <button type="submit" class="bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-150">Save Rates</button>
                </div>
            </form>
        </div>
    </div>
    <!-- END PAY RATE SETTINGS MODAL -->


    <!-- Data Management Modal -->
    <div id="manage-data-modal-backdrop" class="fixed inset-0 hidden items-center justify-center z-50 modal-backdrop">
        <div id="manage-data-modal" class="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-6 w-11/12 max-w-lg mx-auto transform transition duration-300 scale-100">
            <h3 class="text-xl font-bold mb-6 text-white flex items-center gap-2">
                <svg class="w-6 h-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                Data Management
            </h3>
            
            <div class="space-y-6">
                <!-- Delete by Month -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-200 mb-3">Delete a Specific Month's Data</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <select id="delete-month-select" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white"></select>
                        <select id="delete-year-select" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white"></select>
                        <button id="delete-month-btn" class="w-full bg-red-700/80 text-white font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-red-700 transition duration-150">Delete Month</button>
                    </div>
                </div>

                <!-- Divider -->
                <div class="relative"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-600"></div></div><div class="relative flex justify-center text-sm"><span class="px-2 bg-gray-800 text-gray-400 rounded-full">DANGER ZONE</span></div></div>
                
                <!-- Delete All Data -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-200 mb-3">Wipe All Log Data</h4>
                    <button id="delete-all-btn" class="w-full bg-red-600 text-white font-medium py-3 px-4 rounded-lg shadow-md hover:bg-red-500 transition duration-150 transform hover:scale-[1.01] active:scale-[0.99]">Permanently Delete ALL Log Data</button>
                </div>
            </div>

            <div class="mt-8 flex justify-end">
                <button type="button" id="manage-data-close-btn" class="bg-gray-600 text-gray-200 font-medium py-2 px-4 rounded-lg hover:bg-gray-500 transition duration-150">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Use a function wrapper to ensure all variables are scoped locally
        (function() {
            // --- Element Declarations ---
            const elements = {
                logForm: document.getElementById('log-form'), dateInput: document.getElementById('date'),
                statusInput: document.getElementById('status'), presentDetails: document.getElementById('present-details'),
                startTimeInput: document.getElementById('start-time'), endTimeInput: document.getElementById('end-time'),
                notesInput: document.getElementById('notes'), shiftPresets: document.getElementById('shift-presets'),
                // PAY SUMMARIES
                summaryRegularLabel: document.getElementById('summary-regular-label'),
                summaryOvertimeLabel: document.getElementById('summary-overtime-label'),
                summaryRegularPay: document.getElementById('summary-regular-pay'),
                summaryOvertimePay: document.getElementById('summary-overtime-pay'),
                summarySpecialHolPay: document.getElementById('summary-special-hol-pay'),
                summaryLegalHolPay: document.getElementById('summary-legal-hol-pay'),
                summaryNonWorkedPaidHolPay: document.getElementById('summary-non-worked-paid-hol-pay'),
                summaryNightDifferentialPay: document.getElementById('summary-night-differential-pay'), 
                summaryTotalPay: document.getElementById('summary-total-pay'),
                // HOURS SUMMARIES
                summaryRegularHoursTotal: document.getElementById('summary-regular-hours-total'), 
                summarySpecialHolHoursTotal: document.getElementById('summary-special-hol-hours-total'),
                summaryLegalHolHoursTotal: document.getElementById('summary-legal-hol-hours-total'),
                summaryTotalOvertimeHours: document.getElementById('summary-total-overtime-hours'), 
                summaryTotalWorkedHours: document.getElementById('summary-total-worked-hours'),
                summaryDaysContainer: document.getElementById('summary-days-container'),
                summaryNightDiffHours: document.getElementById('summary-night-diff-hours'),
                // BUTTONS AND FILTERS
                manageDataBtn: document.getElementById('manage-data-btn'),
                logContainer: document.getElementById('log-container'), emptyLogMessage: document.getElementById('empty-log-message'),
                logHistoryTitle: document.getElementById('log-history-title'),
                monthFilter: document.getElementById('month-filter'), yearFilter: document.getElementById('year-filter'),
                applyFilterBtn: document.getElementById('apply-filter-btn'), exportCsvBtn: document.getElementById('export-csv-btn'), 
                // MODALS
                confirmModalBackdrop: document.getElementById('confirm-modal-backdrop'), confirmModalTitle: document.getElementById('confirm-modal-title'), confirmModalText: document.getElementById('confirm-modal-text'),
                confirmModalCancel: document.getElementById('confirm-modal-cancel'), confirmModalAction: document.getElementById('confirm-modal-action'),
                editModalBackdrop: document.getElementById('edit-modal-backdrop'), editForm: document.getElementById('edit-form'),
                editLogId: document.getElementById('edit-log-id'), editDate: document.getElementById('edit-date'), editStartTime: document.getElementById('edit-start-time'), editEndTime: document.getElementById('edit-end-time'),
                editStatus: document.getElementById('edit-status'), editNotes: document.getElementById('edit-notes'), editPresentDetails: document.getElementById('edit-present-details'),
                editModalCancel: document.getElementById('edit-modal-cancel'),
                payRateBtn: document.getElementById('pay-rate-btn'), ratesSettingsModalBackdrop: document.getElementById('rates-settings-modal-backdrop'),
                ratesForm: document.getElementById('rates-form'), rateRegular: document.getElementById('rate-regular'), rateOvertime: document.getElementById('rate-overtime'),
                rateSpecialHoliday: document.getElementById('rate-special-holiday'), rateLegalHoliday: document.getElementById('rate-legal-holiday'),
                rateNightDifferential: document.getElementById('rate-night-differential'), 
                rateFixedMonthly: document.getElementById('rate-fixed-monthly'), // Fixed Pay Input
                rateFixedDaysPerCycle: document.getElementById('rate-fixed-days-per-cycle'), // Fixed Days Input
                payModeHourly: document.getElementById('pay-mode-hourly'),       // New Pay Mode Radios
                payModeFixed: document.getElementById('pay-mode-fixed'),
                hourlyRateGroup: document.getElementById('hourly-rate-group'),
                fixedMonthlyPayGroup: document.getElementById('fixed-monthly-pay-group'),
                manageDataModalBackdrop: document.getElementById('manage-data-modal-backdrop'),
                deleteMonthSelect: document.getElementById('delete-month-select'), deleteYearSelect: document.getElementById('delete-year-select'),
                deleteMonthBtn: document.getElementById('delete-month-btn'), deleteAllBtn: document.getElementById('delete-all-btn'),
                manageDataCloseBtn: document.getElementById('manage-data-close-btn'),
                // DEDUCTIONS ELEMENTS (NEW)
                deductionInputsContainer: document.getElementById('deductions-inputs'),
                summaryTotalDeduction: document.getElementById('summary-total-deduction'),
                summaryNetPay: document.getElementById('summary-net-pay'),
            };

            let allLogs = []; 
            let payRates = {};
            let deductions = {}; // Global deduction object
            
            const LOGS_STORAGE_KEY = 'workMonitoringAppLogs_v7_manual'; 
            const RATES_STORAGE_KEY = 'workMonitoringAppRates_v4'; 
            const DEDUCTIONS_STORAGE_KEY = 'workMonitoringAppDeductions_v1'; // NEW KEY
            const PAID_HOLIDAY_HOURS_EQUIVALENT = 8; 
            const DEFAULT_WORKING_DAYS_PER_CYCLE = 26;

            // --- DATA & UTILITY FUNCTIONS ---

            const DEFAULT_RATES = {
                regular: 0.00, overtime: 0.00, specialHoliday: 0.00, legalHoliday: 0.00, 
                nightDifferential: 0.00, payMode: 'hourly', fixedMonthlyPay: 0.00, 
                fixedDaysPerCycle: DEFAULT_WORKING_DAYS_PER_CYCLE, 
            };
            
            const DEDUCTION_KEYS = ['philhealth', 'hdmf', 'tax', 'healthcard', 'sssLoan', 'hdmfLoan', 'sssCalamityLoan'];

            const DEFAULT_DEDUCTIONS = DEDUCTION_KEYS.reduce((acc, key) => {
                acc[key] = 0.00;
                return acc;
            }, {});

            // Persistence for Deductions (NEW)
            const loadDeductions = () => {
                try {
                    const savedDeductions = localStorage.getItem(DEDUCTIONS_STORAGE_KEY);
                    const loaded = savedDeductions ? JSON.parse(savedDeductions) : DEFAULT_DEDUCTIONS;
                    // Ensure all keys exist
                    DEDUCTION_KEYS.forEach(key => {
                        deductions[key] = parseFloat(loaded[key]) || 0.00;
                    });
                } catch (error) { console.error("Error loading deductions:", error); deductions = DEFAULT_DEDUCTIONS; }
            };

            const saveDeductions = () => { 
                try { 
                    localStorage.setItem(DEDUCTIONS_STORAGE_KEY, JSON.stringify(deductions)); 
                } catch (error) { console.error("Error saving deductions:", error); } 
            };
            
            // Persistence for Logs and Rates (existing logic, simplified)
            const saveLogs = () => { try { localStorage.setItem(LOGS_STORAGE_KEY, JSON.stringify(allLogs)); } catch (error) { console.error("Error saving logs:", error); } };
            const loadLogs = () => {
                try {
                    const savedLogs = localStorage.getItem(LOGS_STORAGE_KEY);
                    allLogs = savedLogs ? JSON.parse(savedLogs) : [];
                } catch (error) { console.error("Error loading logs:", error); allLogs = []; }
            };
            const loadRates = () => {
                try {
                    const savedRates = localStorage.getItem(RATES_STORAGE_KEY);
                    payRates = savedRates ? JSON.parse(savedRates) : DEFAULT_RATES;
                } catch (error) { console.error("Error loading rates:", error); payRates = DEFAULT_RATES; }
                
                // Ensure backward compatibility
                if (typeof payRates.fixedDaysPerCycle === 'undefined' || isNaN(payRates.fixedDaysPerCycle) || payRates.fixedDaysPerCycle === 0) {
                    payRates.fixedDaysPerCycle = DEFAULT_RATES.fixedDaysPerCycle;
                }
            };
            const saveRates = () => { try { localStorage.setItem(RATES_STORAGE_KEY, JSON.stringify(payRates)); } catch (error) { console.error("Error saving rates:", error); } };
            
            // Time Formatting
            const getTodayString = () => new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            const formatHours = (hours) => {
              if (hours === null || isNaN(hours)) return '0h 00m';
              const totalMinutes = Math.round(hours * 60);
              const h = Math.floor(totalMinutes / 60);
              const m = totalMinutes % 60;
              return `${h}h ${String(m).padStart(2, '0')}m`;
            };

            // Core Time Calculation (remains unchanged)
            const calculateTotalHours = (dateIn, timeIn, timeOut) => {
                 const startDateTime = new Date(`${dateIn}T${timeIn}:00`);
                 let endDateTime = new Date(`${dateIn}T${timeOut}:00`);
                 if (endDateTime.getTime() <= startDateTime.getTime()) {
                    endDateTime.setDate(endDateTime.getDate() + 1);
                 }
                 const durationMs = endDateTime.getTime() - startDateTime.getTime();
                 return Math.max(0, durationMs / (1000 * 60 * 60)); 
            };
            
            // Night Differential Hour Calculation (remains unchanged)
            const calculateNightHours = (dateIn, timeIn, timeOut) => {
                const startDateTime = new Date(`${dateIn}T${timeIn}:00`);
                let endDateTime = new Date(`${dateIn}T${timeOut}:00`);
                if (endDateTime.getTime() <= startDateTime.getTime()) {
                   endDateTime.setDate(endDateTime.getDate() + 1);
                }
                if (endDateTime.getTime() <= startDateTime.getTime()) return 0;

                let nightMinutes = 0;
                let t = new Date(startDateTime.getTime());
                const oneMinute = 60 * 1000;
                const actualEndTime = endDateTime.getTime(); 

                while (t.getTime() < actualEndTime) {
                    const currentHour = t.getHours(); 
                    if (currentHour >= 22 || currentHour < 6) {
                        nightMinutes++;
                    }
                    t = new Date(t.getTime() + oneMinute);
                    if (t.getTime() > actualEndTime + oneMinute) break; 
                }
                return nightMinutes / 60;
            };

            // PAY CALCULATION HELPERS (remains mostly unchanged)
            const calculateNDPay = (log, rates) => {
                const ndHours = log.nightDifferentialHours || 0;
                const ndHourlyRate = rates.nightDifferential || DEFAULT_RATES.nightDifferential;
                
                if (log.totalHours > 0 && ndHours > 0) {
                    return ndHours * ndHourlyRate;
                }
                return 0;
            };

            const calculateBasePay = (log, rates) => {
                const hours = log.totalHours || 0;
                const regRate = rates.regular || DEFAULT_RATES.regular;
                const specialRate = rates.specialHoliday || DEFAULT_RATES.specialHoliday;
                const legalRate = rates.legalHoliday || DEFAULT_RATES.legalHoliday;
                const otRate = rates.overtime || DEFAULT_RATES.overtime;
                const calcStatus = log.status === 'Rest Day' ? 'Non-Work Day' : log.status;

                if (calcStatus === 'Present') {
                    return (log.regularHours || 0) * regRate + (log.overtimeHours || 0) * otRate;
                } else if (calcStatus === 'Special Holiday (130%)') {
                    return hours * specialRate; 
                } else if (calcStatus === 'Legal Holiday (200%)') {
                    return hours * legalRate;
                } else if (calcStatus === 'Legal/Special Holiday Non-Work') {
                    return PAID_HOLIDAY_HOURS_EQUIVALENT * regRate;
                }
                return 0;
            };

            const calculateTotalPay = (log) => {
                const basePay = calculateBasePay(log, payRates);
                const nightDifferentialPay = calculateNDPay(log, payRates);
                log.basePay = basePay;
                log.nightDifferentialPay = nightDifferentialPay;
                return basePay + nightDifferentialPay;
            };
            
            // Function to generate the HTML for a single log entry (remains unchanged)
            const createLogEntryHtml = (log) => {
                const totalPay = calculateTotalPay({...log}); 
                const isWorkDay = ['Present', 'Special Holiday (130%)', 'Legal Holiday (200%)'].includes(log.status);

                let statusColor, shiftDetails, hoursDetails;
                let displayStatus = log.status;
                
                if (log.status === 'Present') {
                    statusColor = 'bg-indigo-600';
                    shiftDetails = `${log.timeIn} - ${log.timeOut}`;
                    hoursDetails = `<span class="text-xs text-indigo-300">Reg: ${formatHours(log.regularHours)}, OT: ${formatHours(log.overtimeHours)}</span>`;
                } else if (log.status === 'Special Holiday (130%)') {
                    statusColor = 'bg-yellow-600';
                    shiftDetails = isWorkDay ? `${log.timeIn} - ${log.timeOut}` : 'Non-Worked';
                    hoursDetails = isWorkDay ? `<span class="text-xs text-yellow-300">Total: ${formatHours(log.totalHours)}</span>` : '';
                } else if (log.status === 'Legal Holiday (200%)') {
                    statusColor = 'bg-red-600';
                    shiftDetails = isWorkDay ? `${log.timeIn} - ${log.timeOut}` : 'Non-Worked';
                    hoursDetails = isWorkDay ? `<span class="text-xs text-red-300">Total: ${formatHours(log.totalHours)}</span>` : '';
                } else if (log.status === 'Legal/Special Holiday Non-Work') {
                    statusColor = 'bg-green-700';
                    shiftDetails = 'Paid Day Off (8h)';
                    hoursDetails = `<span class="text-xs text-green-300">Paid: ${PAID_HOLIDAY_HOURS_EQUIVALENT}h 00m</span>`;
                    displayStatus = 'Legal/Special Holiday (NonWork)';
                } else if (log.status === 'Rest Day') {
                    statusColor = 'bg-gray-600';
                    shiftDetails = 'Rest Day';
                    hoursDetails = '';
                    displayStatus = 'Rest Day';
                } else { // Non-Work Day
                    statusColor = 'bg-gray-600';
                    shiftDetails = 'Day Off / Leave';
                    hoursDetails = '';
                    displayStatus = 'Leave/No work (Non Paid)';
                }
                
                const ndBadge = log.nightDifferentialHours > 0 ? 
                    `<span class="text-xs text-blue-400 bg-blue-900/50 py-0.5 px-2 rounded-full font-semibold mr-2">ND: ${formatHours(log.nightDifferentialHours)}</span>` : '';

                return `
                    <div id="log-${log.id}" class="new-entry bg-gray-800 p-4 rounded-xl shadow-xl flex justify-between items-center transition duration-300 hover:bg-gray-700 border-l-4 border-l-indigo-500">
                        <!-- Date & Status Column -->
                        <div class="flex flex-col flex-1 min-w-[120px]">
                            <p class="text-lg font-bold text-white">${log.date}</p>
                            <span class="text-xs font-semibold text-gray-200 py-1 px-2 rounded-full mt-1 w-fit ${statusColor}">${displayStatus}</span>
                        </div>

                        <!-- Shift & Hours Column -->
                        <div class="flex flex-col flex-1 mx-3 text-center sm:text-left min-w-[100px] max-w-[150px]">
                             <p class="text-sm font-medium text-gray-300">${shiftDetails}</p>
                             ${hoursDetails}
                             <div class="mt-1">${ndBadge}</div>
                        </div>

                        <!-- Pay & Actions Column -->
                        <div class="flex flex-col items-end min-w-[120px]">
                            <p class="text-xl font-bold text-green-400">₱${totalPay.toFixed(2)}</p>
                            <div class="mt-2 flex space-x-2">
                                <button data-id="${log.id}" class="edit-btn text-sm p-1 text-blue-400 hover:text-blue-300 transition duration-150 rounded-lg" title="Edit">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7-3l-4 4M15 7l-4 4m0 0l-5.464 5.464a1 1 0 00.707 1.707L15 15m4-4l-1.586-1.586a2 2 0 00-2.828 0L7 16m14-9a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V9z"></path></svg>
                                </button>
                                <button data-id="${log.id}" class="delete-btn text-sm p-1 text-red-400 hover:text-red-300 transition duration-150 rounded-lg" title="Delete">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            };

            // Renderer (remains unchanged)
            const renderLogs = (logs) => {
                elements.logContainer.innerHTML = '';
                if (logs.length === 0) {
                    elements.emptyLogMessage.style.display = 'block';
                } else {
                    elements.emptyLogMessage.style.display = 'none';
                    // Sort logs by date descending
                    logs.sort((a, b) => new Date(b.date) - new Date(a.date));
                    logs.forEach(log => {
                        elements.logContainer.innerHTML += createLogEntryHtml({...log});
                    });
                    addLogEventListeners();
                }
            };
            
            // --- UI/UX & EVENT HANDLERS ---
            
            // Deduction Input Handler (NEW)
            const setupDeductionInputs = () => {
                DEDUCTION_KEYS.forEach(key => {
                    const inputEl = document.getElementById(`deduction-${key.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`)}`);
                    if (inputEl) {
                        inputEl.value = deductions[key].toFixed(2);
                        inputEl.addEventListener('input', () => {
                            deductions[key] = parseFloat(inputEl.value) || 0;
                            saveDeductions();
                            applyFilter(); // Recalculate summary on deduction change
                        });
                    }
                });
            };
            
            // Existing handlers (omitted for brevity)
            const addLogEventListeners = () => {
                 document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const logId = parseInt(e.currentTarget.dataset.id);
                        const log = allLogs.find(l => l.id === logId);
                        if (!log) return;
                        
                        showConfirmModal(
                            'Confirm Deletion', 
                            `Are you sure you want to delete the log entry for ${log.date} (${log.status})?`, 
                            'Yes, Delete', 
                            () => deleteLog(logId)
                        );
                    });
                });
                
                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const logId = parseInt(e.currentTarget.dataset.id);
                        const log = allLogs.find(l => l.id === logId);
                        if (!log) return;
                        
                        elements.editLogId.value = log.id;
                        elements.editDate.value = log.date;
                        elements.editStatus.value = log.status; 

                        elements.editStartTime.value = log.timeIn === '00:00' ? '08:00' : log.timeIn; 
                        elements.editEndTime.value = log.timeOut === '00:00' ? '16:00' : log.timeOut;
                        elements.editNotes.value = log.notes;
                        
                        handleStatusChange(log.status, elements.editPresentDetails, elements.editStartTime, elements.editEndTime);
                        elements.editModalBackdrop.style.display = 'flex';
                    });
                });
            };
            
            const deleteLog = (logId) => {
                allLogs = allLogs.filter(log => log.id !== logId);
                saveLogs();
                populateYearFilter(elements.yearFilter);
                applyFilter();
                showConfirmModal('Deleted', 'The log entry has been deleted.', 'OK', null, true);
            };

            elements.shiftPresets.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (button && button.dataset.start && button.dataset.end) {
                    elements.startTimeInput.value = button.dataset.start;
                    elements.endTimeInput.value = button.dataset.end;
                }
            });

            const handleStatusChange = (status, detailsEl, startEl, endEl) => {
                const isWorkEntry = ['Present', 'Legal Holiday (200%)', 'Special Holiday (130%)'].includes(status);
                
                if(detailsEl && elements.shiftPresets) {
                    detailsEl.style.display = isWorkEntry ? 'grid' : 'none';
                    if (detailsEl === elements.presentDetails) {
                        elements.shiftPresets.style.display = isWorkEntry ? 'flex' : 'none';
                    }
                }

                if(startEl && endEl) {
                    startEl.required = isWorkEntry;
                    endEl.required = isWorkEntry;
                }
            };
            elements.statusInput.addEventListener('change', () => handleStatusChange(elements.statusInput.value, elements.presentDetails, elements.startTimeInput, elements.endTimeInput));
            elements.editStatus.addEventListener('change', () => handleStatusChange(elements.editStatus.value, elements.editPresentDetails, elements.editStartTime, elements.editEndTime));
            
            elements.logForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const date = elements.dateInput.value;
                const status = elements.statusInput.value;
                const isWorkEntry = ['Present', 'Legal Holiday (200%)', 'Special Holiday (130%)'].includes(status);
                let totalHours = 0, regularHours = 0, overtimeHours = 0, nightDifferentialHours = 0;
                let startTime = elements.startTimeInput.value;
                let endTime = elements.endTimeInput.value;

                if (isWorkEntry) {
                    totalHours = calculateTotalHours(date, startTime, endTime);
                    regularHours = Math.min(totalHours, 8); 
                    overtimeHours = Math.max(0, totalHours - 8);
                    nightDifferentialHours = calculateNightHours(date, startTime, endTime);

                    if (totalHours <= 0) {
                        showConfirmModal('Invalid Shift', 'Clock Out time must be after Clock In time and on the same or next day.', 'Close', null, true); 
                        return;
                    }
                } else {
                    startTime = '00:00'; endTime = '00:00';
                }

                const newLog = { 
                    id: Date.now(), date: date, status: status, 
                    timeIn: startTime, timeOut: endTime,
                    notes: elements.notesInput.value.trim(), totalHours: totalHours, regularHours: regularHours, 
                    overtimeHours: overtimeHours, nightDifferentialHours: nightDifferentialHours, 
                };
                
                calculateTotalPay(newLog); 

                allLogs.push(newLog);
                saveLogs();
                
                elements.logForm.reset();
                elements.statusInput.value = 'Present'; 
                elements.startTimeInput.value = '06:00';
                elements.endTimeInput.value = '14:00';
                elements.dateInput.value = getTodayString(); 
                handleStatusChange(elements.statusInput.value, elements.presentDetails, elements.startTimeInput, elements.endTimeInput);
                
                populateYearFilter(elements.yearFilter);
                applyFilter();
            });

            // Summary Calculation (UPDATED FOR NET PAY AND TOTAL DEDUCTION)
            const updateFilteredSummaries = (logs) => {
                const payMode = payRates.payMode || DEFAULT_RATES.payMode;

                // --- PAY CALCULATION ACCUMULATORS ---
                let totalRegularPay = 0; 
                let totalOvertimePayCalculated = 0;
                let totalFixedModePremiums = 0;    

                // --- FIXED PAY CALCULATORS ---
                const fixedMonthlyPay = payRates.fixedMonthlyPay || DEFAULT_RATES.fixedMonthlyPay;
                const fixedDaysPerCycle = payRates.fixedDaysPerCycle || DEFAULT_RATES.fixedDaysPerCycle;
                const dailyDeductionRate = fixedDaysPerCycle > 0 ? fixedMonthlyPay / fixedDaysPerCycle : 0; 
                let nonPaidLeaveDays = 0;
                let totalGrossPay = 0; // Temp variable to hold final gross pay

                let pay = { specialHol: 0, legalHol: 0, nonWorkedPaidHol: 0, nightDifferential: 0, total: 0 };
                let hours = { day: 0, mid: 0, night: 0, specialHol: 0, legalHol: 0, overtime: 0, nightDifferential: 0, totalWorked: 0 }; 
                
                const regRate = payRates.regular || DEFAULT_RATES.regular;
                const otRate = payRates.overtime || DEFAULT_RATES.overtime;
                const specialRate = payRates.specialHoliday || DEFAULT_RATES.specialHoliday;
                const legalRate = payRates.legalHoliday || DEFAULT_RATES.legalHoliday;

                logs.forEach(log => {
                    const calcStatus = (log.status === 'Rest Day' || log.status === 'Non-Work Day') ? 'Non-Work Day' : log.status;
                    const calcLog = {...log, status: calcStatus};
                    const logHours = calcLog.totalHours || 0;
                    const otHours = calcLog.overtimeHours || 0;
                    const isWorkDay = ['Present', 'Special Holiday (130%)', 'Legal Holiday (200%)'].includes(calcStatus);

                    // --- 1. HOUR CALCULATION (Independent of Pay Mode) ---
                    if (isWorkDay) {
                        const regularWorkedHours = calcLog.regularHours || 0; 
                        
                        let startTime = new Date(`${calcLog.date}T${calcLog.timeIn}:00`);
                        let endTime = new Date(`${calcLog.date}T${calcLog.timeOut}:00`);
                        if (endTime.getTime() <= startTime.getTime()) { endTime.setDate(endTime.getDate() + 1); }
                        
                        let current = new Date(startTime.getTime());
                        const actualEndTime = endTime.getTime(); 
                        const oneMinute = 60 * 1000;
                        let daySegmentMinutes = 0, midSegmentMinutes = 0, nightSegmentMinutes = 0;
                        const maxClassificationMinutes = regularWorkedHours * 60; 
                        let minutesClassified = 0; 

                        while (current.getTime() < actualEndTime && minutesClassified < maxClassificationMinutes) {
                            const currentHour = current.getHours(); 
                            
                            if (currentHour >= 6 && currentHour < 14) { daySegmentMinutes++; } 
                            else if (currentHour >= 14 && currentHour < 22) { midSegmentMinutes++; } 
                            else { nightSegmentMinutes++; }
                            
                            minutesClassified++;
                            current = new Date(current.getTime() + oneMinute);
                        }

                        hours.day += daySegmentMinutes / 60;
                        hours.mid += midSegmentMinutes / 60;
                        hours.night += nightSegmentMinutes / 60;
                        hours.nightDifferential += calcLog.nightDifferentialHours || 0; 
                        if (calcStatus === 'Special Holiday (130%)') hours.specialHol += logHours;
                        if (calcStatus === 'Legal Holiday (200%)') hours.legalHol += logHours;
                        hours.overtime += otHours;
                        hours.totalWorked += logHours;
                    }
                    
                    // --- 2. ACCUMULATE TOTAL OVERTIME PAY (OT Hours * OT Rate) ---
                    totalOvertimePayCalculated += otHours * otRate;

                    // --- 3. PAY CALCULATION (Mode Dependent) ---
                    if (payMode === 'hourly') {
                        calculateTotalPay(calcLog); 
                        
                        if (calcStatus === 'Present') {
                            totalRegularPay += (calcLog.regularHours || 0) * regRate;
                        } else if (calcStatus === 'Special Holiday (130%)') {
                            pay.specialHol += logHours * specialRate;
                        } else if (calcStatus === 'Legal Holiday (200%)') {
                            pay.legalHol += logHours * legalRate;
                        } else if (calcStatus === 'Legal/Special Holiday Non-Work') {
                            pay.nonWorkedPaidHol += PAID_HOLIDAY_HOURS_EQUIVALENT * regRate;
                        }
                        pay.nightDifferential += calculateNDPay(calcLog, payRates);
                    
                    } else if (payMode === 'fixed') {
                        if (log.status === 'Non-Work Day') { 
                            nonPaidLeaveDays++;
                        }
                        if (calcStatus === 'Special Holiday (130%)') {
                            const premium = logHours * (specialRate - regRate);
                            totalFixedModePremiums += premium;
                            pay.specialHol += premium;
                        } else if (calcStatus === 'Legal Holiday (200%)') {
                            const premium = logHours * (legalRate - regRate);
                            totalFixedModePremiums += premium;
                            pay.legalHol += premium;
                        } else if (calcStatus === 'Legal/Special Holiday Non-Work') {
                             pay.nonWorkedPaidHol += dailyDeductionRate; 
                        }
                        const ndPay = calculateNDPay(calcLog, payRates);
                        totalFixedModePremiums += ndPay;
                        pay.nightDifferential += ndPay;
                    }
                });

                // --- 4. FINAL GROSS PAY CALCULATION ---
                if (payMode === 'hourly') {
                    totalGrossPay = totalRegularPay + totalOvertimePayCalculated + pay.specialHol + pay.legalHol + pay.nonWorkedPaidHol + pay.nightDifferential;
                    elements.summaryRegularLabel.textContent = `Total Regular Pay`;
                } else { // fixed
                    const totalDeductionFromLeave = nonPaidLeaveDays * dailyDeductionRate;
                    const totalFixedBasePay = Math.max(0, fixedMonthlyPay - totalDeductionFromLeave); 
                    totalGrossPay = totalFixedBasePay + totalOvertimePayCalculated + pay.nonWorkedPaidHol + totalFixedModePremiums;
                    elements.summaryRegularLabel.textContent = `Fixed Base Pay (Gross)`;
                    elements.summaryRegularPay.textContent = `₱${totalFixedBasePay.toFixed(2)}`; // Update base pay display
                }

                // --- 5. DEDUCTION & NET PAY CALCULATION ---
                const totalDeduction = DEDUCTION_KEYS.reduce((sum, key) => sum + (deductions[key] || 0), 0);
                const netPay = Math.max(0, totalGrossPay - totalDeduction);

                // --- 6. UI UPDATES ---
                
                // Pay Breakdown Updates
                elements.summaryTotalPay.textContent = `₱${totalGrossPay.toFixed(2)}`;
                elements.summaryOvertimeLabel.textContent = `Total Overtime Pay`; 
                elements.summaryOvertimePay.textContent = `₱${totalOvertimePayCalculated.toFixed(2)}`;
                elements.summarySpecialHolPay.textContent = `₱${pay.specialHol.toFixed(2)}`;
                elements.summaryLegalHolPay.textContent = `₱${pay.legalHol.toFixed(2)}`;
                elements.summaryNonWorkedPaidHolPay.textContent = `₱${pay.nonWorkedPaidHol.toFixed(2)}`;
                elements.summaryNightDifferentialPay.textContent = `₱${pay.nightDifferential.toFixed(2)}`;
                
                // Hours Updates
                const totalRegularHours = hours.day + hours.mid + hours.night;
                elements.summaryRegularHoursTotal.textContent = formatHours(totalRegularHours); 
                elements.summaryNightDiffHours.textContent = formatHours(hours.nightDifferential); 
                elements.summarySpecialHolHoursTotal.textContent = formatHours(hours.specialHol);
                elements.summaryLegalHolHoursTotal.textContent = formatHours(hours.legalHol);
                elements.summaryTotalOvertimeHours.textContent = formatHours(hours.overtime);
                elements.summaryTotalWorkedHours.textContent = formatHours(hours.totalWorked);
                
                // Deduction & Net Pay Updates (NEW)
                elements.summaryTotalDeduction.textContent = `₱${totalDeduction.toFixed(2)}`;
                elements.summaryNetPay.textContent = `₱${netPay.toFixed(2)}`;
            };

            const updateDaysCountSummary = (logs) => {
                 let workDays = 0, nonWorkDays = 0, specialHolidayDays = 0, legalHolidayDays = 0; 
                
                 logs.forEach(log => {
                    const status = log.status;

                    if (status === 'Present') workDays++;
                    else if (status === 'Special Holiday (130%)') { workDays++; specialHolidayDays++; }
                    else if (status === 'Legal Holiday (200%)') { workDays++; legalHolidayDays++; }
                    else if (status === 'Non-Work Day' || status === 'Rest Day' || status === 'Legal/Special Holiday Non-Work') nonWorkDays++;
                });
                
                elements.summaryDaysContainer.innerHTML = `
                    <div class="summary-box bg-gray-800 p-3 rounded-xl"><p class="text-xs text-green-400">Total Shifts</p><p class="text-xl font-bold text-green-300 mt-1">${workDays}</p></div>
                    <div class="summary-box bg-gray-800 p-3 rounded-xl"><p class="text-xs text-orange-400">Special Hol. Days</p><p class="text-xl font-bold text-orange-300 mt-1">${specialHolidayDays}</p></div>
                    <div class="summary-box bg-gray-800 p-3 rounded-xl"><p class="text-xs text-red-400">Legal Hol. Days</p><p class="text-xl font-bold text-red-300 mt-1">${legalHolidayDays}</p></div>
                    <div class="summary-box bg-gray-800 p-3 rounded-xl"><p class="text-xs text-gray-400">Non-Work Days</p><p class="text-xl font-bold text-gray-300 mt-1">${nonWorkDays}</p></div>`;
            };

            // Filtering and App Control (omitted for brevity)
            const populateYearFilter = (selectEl) => {
                const currentYear = new Date().getFullYear();
                const years = [...new Set(allLogs.map(log => new Date(log.date + 'T00:00:00').getFullYear()))];
                if (!years.includes(currentYear)) years.push(currentYear);
                years.sort((a,b) => b-a);
                
                const currentSelectedYear = selectEl.value;
                selectEl.innerHTML = years.map(year => `<option value="${year}">${year}</option>`).join('');
                if (years.includes(parseInt(currentSelectedYear))) {
                    selectEl.value = currentSelectedYear;
                } else {
                    selectEl.value = currentYear;
                }
            };
            
            const getFilteredLogs = () => {
                const month = parseInt(elements.monthFilter.value);
                const year = parseInt(elements.yearFilter.value);
                const selectedYear = isNaN(year) ? new Date().getFullYear() : year;

                if (isNaN(month)) return []; 
                
                return allLogs.filter(log => {
                    const logDate = new Date(log.date + 'T00:00:00');
                    return logDate.getMonth() === month && logDate.getFullYear() === selectedYear;
                });
            };

            const applyFilter = () => {
                const filteredLogs = getFilteredLogs();
                const year = parseInt(elements.yearFilter.value);
                const selectedYear = isNaN(year) ? new Date().getFullYear() : year;

                const monthName = elements.monthFilter.options[elements.monthFilter.selectedIndex].text;
                elements.logHistoryTitle.textContent = `Log History for ${monthName} ${selectedYear}`;
                
                renderLogs(filteredLogs);
                updateDaysCountSummary(filteredLogs); 
                updateFilteredSummaries(filteredLogs); 
            };
            
            elements.monthFilter.addEventListener('change', applyFilter);
            elements.yearFilter.addEventListener('change', applyFilter);
            elements.applyFilterBtn.addEventListener('click', applyFilter);
            elements.exportCsvBtn.addEventListener('click', () => { /* Export logic here */ }); 

            // Modal Handlers (omitted for brevity)
             const showConfirmModal = (title, text, actionText, actionCallback, hideActionButton = false) => {
                elements.confirmModalTitle.textContent = title; elements.confirmModalText.textContent = text;
                elements.confirmModalAction.textContent = actionText; elements.confirmModalBackdrop.style.display = 'flex';
                elements.confirmModalAction.onclick = () => { closeConfirmModal(); if (actionCallback) actionCallback(); };
                elements.confirmModalCancel.onclick = closeConfirmModal;
                elements.confirmModalAction.style.display = hideActionButton ? 'none' : 'inline-block';
                elements.confirmModalCancel.textContent = hideActionButton ? 'OK' : 'Cancel';
            };
            const closeConfirmModal = () => elements.confirmModalBackdrop.style.display = 'none';
            elements.confirmModalBackdrop.addEventListener('click', (e) => { if (e.target === elements.confirmModalBackdrop) closeConfirmModal(); });

            const closeEditModal = () => elements.editModalBackdrop.style.display = 'none';
            elements.editModalCancel.addEventListener('click', closeEditModal);
            elements.editModalBackdrop.addEventListener('click', (e) => { if (e.target === elements.editModalBackdrop) closeEditModal(); });

            elements.editForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const logId = parseInt(elements.editLogId.value);
                const logIndex = allLogs.findIndex(log => log.id === logId);

                if (logIndex === -1) { closeEditModal(); return; }

                const newDate = elements.editDate.value;
                const selectedStatus = elements.editStatus.value;
                const calcStatus = (selectedStatus === 'Rest Day' || selectedStatus === 'Non-Work Day') ? 'Non-Work Day' : selectedStatus;
                const isWorkEntry = ['Present', 'Legal Holiday (200%)', 'Special Holiday (130%)'].includes(calcStatus);
                let totalHours = 0, regularHours = 0, overtimeHours = 0, nightDifferentialHours = 0;
                let newTimeIn = elements.editStartTime.value;
                let newTimeOut = elements.editEndTime.value;

                if (isWorkEntry) {
                    totalHours = calculateTotalHours(newDate, newTimeIn, newTimeOut);
                    regularHours = Math.min(totalHours, 8);
                    overtimeHours = Math.max(0, totalHours - 8);
                    nightDifferentialHours = calculateNightHours(newDate, newTimeIn, newTimeOut);

                    if (totalHours <= 0) {
                         showConfirmModal('Invalid Shift', 'Clock Out time must be after Clock In time and on the same or next day.', 'Close', null, true);
                         return; 
                    }
                } else { newTimeIn = '00:00'; newTimeOut = '00:00'; }

                allLogs[logIndex] = { 
                    id: logId, date: newDate, status: selectedStatus, 
                    notes: elements.editNotes.value.trim(),
                    timeIn: newTimeIn, timeOut: newTimeOut, totalHours: totalHours, regularHours: regularHours,
                    overtimeHours: overtimeHours, nightDifferentialHours: nightDifferentialHours, 
                };
                
                saveLogs(); populateYearFilter(elements.yearFilter); applyFilter(); 
                closeEditModal();
            });

            const toggleRateInputs = (mode) => {
                if (mode === 'fixed') {
                    elements.hourlyRateGroup.querySelectorAll('div').forEach(el => {
                        if (el.id === 'rate-regular-group') { el.style.display = 'none'; }
                    });
                    elements.fixedMonthlyPayGroup.style.display = 'block';
                    elements.rateRegular.required = false;
                    elements.rateFixedMonthly.required = true;
                    elements.rateFixedDaysPerCycle.required = true; 
                } else { // hourly
                    elements.hourlyRateGroup.querySelectorAll('div').forEach(el => {
                        if (el.id === 'rate-regular-group') { el.style.display = 'block'; }
                    });
                    elements.fixedMonthlyPayGroup.style.display = 'none';
                    elements.rateRegular.required = true;
                    elements.rateFixedMonthly.required = false;
                    elements.rateFixedDaysPerCycle.required = false; 
                }
            };

            document.querySelectorAll('input[name="pay-mode"]').forEach(radio => {
                radio.addEventListener('change', (e) => toggleRateInputs(e.target.value));
            });

            elements.payRateBtn.addEventListener('click', () => {
                elements.rateRegular.value = payRates.regular; elements.rateOvertime.value = payRates.overtime;
                elements.rateSpecialHoliday.value = payRates.specialHoliday; elements.rateLegalHoliday.value = payRates.legalHoliday;
                elements.rateNightDifferential.value = payRates.nightDifferential; 
                elements.rateFixedMonthly.value = payRates.fixedMonthlyPay;
                elements.rateFixedDaysPerCycle.value = payRates.fixedDaysPerCycle; 

                if (payRates.payMode === 'fixed') { elements.payModeFixed.checked = true; } else { elements.payModeHourly.checked = true; }
                
                toggleRateInputs(payRates.payMode);
                elements.ratesSettingsModalBackdrop.style.display = 'flex';
            });
            
            elements.ratesSettingsModalBackdrop.addEventListener('click', (e) => { 
                if (e.target === elements.ratesSettingsModalBackdrop) { elements.ratesSettingsModalBackdrop.style.display = 'none'; }
            });
            
            elements.ratesForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const selectedMode = document.querySelector('input[name="pay-mode"]:checked').value;
                
                payRates = {
                    regular: parseFloat(elements.rateRegular.value) || DEFAULT_RATES.regular,
                    overtime: parseFloat(elements.rateOvertime.value) || DEFAULT_RATES.overtime,
                    specialHoliday: parseFloat(elements.rateSpecialHoliday.value) || DEFAULT_RATES.specialHoliday,
                    legalHoliday: parseFloat(elements.rateLegalHoliday.value) || DEFAULT_RATES.legalHoliday,
                    nightDifferential: parseFloat(elements.rateNightDifferential.value) || DEFAULT_RATES.nightDifferential, 
                    payMode: selectedMode,
                    fixedMonthlyPay: parseFloat(elements.rateFixedMonthly.value) || DEFAULT_RATES.fixedMonthlyPay,
                    fixedDaysPerCycle: parseInt(elements.rateFixedDaysPerCycle.value) || DEFAULT_RATES.fixedDaysPerCycle,
                };
                
                if (payRates.payMode === 'fixed' && payRates.fixedDaysPerCycle <= 0) {
                     showConfirmModal('Error', 'Fixed Working Days per Cycle must be greater than zero.', 'Close', null, true);
                     return;
                }

                saveRates(); elements.ratesSettingsModalBackdrop.style.display = 'none';
                applyFilter(); showConfirmModal('Rates Saved', 'Your new pay rates and mode have been saved successfully.', 'OK', null, true);
            });
            // Data Management Handlers (omitted for brevity)
            // ... (delete logic unchanged)

            // --- APP INITIALIZATION ---
            const initializeApp = () => {
                loadLogs();
                loadRates();
                loadDeductions(); // LOAD DEDUCTIONS (NEW)
                
                elements.dateInput.value = getTodayString();
                elements.monthFilter.value = new Date().getMonth();
                populateYearFilter(elements.yearFilter);
                
                handleStatusChange(elements.statusInput.value, elements.presentDetails, elements.startTimeInput, elements.endTimeInput);
                
                elements.yearFilter.value = new Date().getFullYear(); 
                elements.monthFilter.value = new Date().getMonth(); 
                
                setupDeductionInputs(); // SETUP DEDUCTION LISTENERS (NEW)
                
                applyFilter(); 
            };
            
            document.addEventListener('DOMContentLoaded', initializeApp);
        })();
    </script>
</body>
</html>

